name: product-iac-repos

on:
  push:
    branches:
      - ammar
    paths:
      - .github/workflows/product-iac-repos.yml
      - iac/terraform/product-iac-repos/workloads/**
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

defaults:
  run:
    shell: bash

jobs:
  configure:
    name: Configure
    runs-on: ubuntu-latest
    outputs:
      base_sha: ${{ env.GIT_BASE_SHA }}
    steps:

      - name: Fetch repository history
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Determine commit SHA to compare against
        run: |
          if [ "${{ github.ref }}" == "refs/heads/ammar" ]; then
            GIT_BASE_SHA=$(git log --format=format:%H --merges --skip 1 -1)
          else
            GIT_BASE_SHA=$(git log --format=format:%H --merges -1)
          fi

          echo "GIT_BASE_SHA=${GIT_BASE_SHA}"
          echo "GIT_BASE_SHA=${GIT_BASE_SHA}" >> $GITHUB_ENV
  
  determine_changes:
    name: Determining Changes
    runs-on: ubuntu-latest
    needs: configure
    outputs:
      LAYER_0_DEV_CHANGES: ${{ env.LAYER_0_DEV_CHANGES }}
      LAYER_1_DEV_CHANGES: ${{ env.LAYER_1_DEV_CHANGES }}
      LAYER_0_TEST_CHANGES: ${{ env.LAYER_0_TEST_CHANGES }}
      LAYER_1_TEST_CHANGES: ${{ env.LAYER_1_TEST_CHANGES }}
      LAYER_0_PROD_CHANGES: ${{ env.LAYER_0_PROD_CHANGES }}
      LAYER_1_PROD_CHANGES: ${{ env.LAYER_1_PROD_CHANGES }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ammar
          fetch-depth: 0

      - name: Finding Layer 0 DEV Changes
        id: layer_0_dev_changes
        run: |
          LAYER_0_DEV_CHANGES=$(git diff --name-only ${{ needs.configure.outputs.base_sha }} HEAD -- ':!prod/**' ':!test/**' ':!**/layer_1/**' ':!**/github/**' ':!.github/**')
          echo "Layer 0 DEV File Changes:"
          echo "$LAYER_0_DEV_CHANGES"

          if [ -n "$LAYER_0_DEV_CHANGES" ]; then
            LAYER_0_DEV_CHANGES=$(echo "$LAYER_0_DEV_CHANGES" | tr '\n' ',' | jq -cRs 'split(",") | .[:-1]')
          else
            LAYER_0_DEV_CHANGES=[]
          fi

          echo "LAYER_0_DEV_CHANGES=${LAYER_0_DEV_CHANGES}" >> $GITHUB_ENV
      
      - name: Finding Layer 1 DEV Changes
        id: layer_1_dev_changes
        run: |
          LAYER_1_DEV_CHANGES=$(git diff --name-only ${{ needs.configure.outputs.base_sha }} HEAD -- ':!prod/**' ':!test/**' ':!**/layer_0/**' ':!**/github/**' ':!.github/**')
          echo "Layer 1 DEV File Changes:"
          echo "$LAYER_1_DEV_CHANGES"
          
          if [ -n "$LAYER_1_DEV_CHANGES" ]; then
            LAYER_1_DEV_CHANGES=$(echo "$LAYER_1_DEV_CHANGES" | tr '\n' ',' | jq -cRs 'split(",") | .[:-1]')
          else
            LAYER_1_DEV_CHANGES=[]
          fi

          echo "LAYER_1_DEV_CHANGES=${LAYER_1_DEV_CHANGES}" >> $GITHUB_ENV
      
      - name: Finding Layer 0 TEST Changes
        id: layer_0_test_changes
        run: |
          LAYER_0_TEST_CHANGES=$(git diff --name-only ${{ needs.configure.outputs.base_sha }} HEAD -- ':!prod/**' ':!dev/**' ':!**/layer_1/**' ':!**/github/**' ':!.github/**')
          echo "Layer 0 TEST File Changes:"
          echo "$LAYER_0_TEST_CHANGES"
          
          if [ -n "$LAYER_0_TEST_CHANGES" ]; then
            LAYER_0_TEST_CHANGES=$(echo "$LAYER_0_TEST_CHANGES" | tr '\n' ',' | jq -cRs 'split(",") | .[:-1]')
          else
            LAYER_0_TEST_CHANGES=[]
          fi

          echo "LAYER_0_TEST_CHANGES=${LAYER_0_TEST_CHANGES}" >> $GITHUB_ENV
      
      - name: Finding Layer 1 TEST Changes
        id: layer_1_test_changes
        run: |
          LAYER_1_TEST_CHANGES=$(git diff --name-only ${{ needs.configure.outputs.base_sha }} HEAD -- ':!prod/**' ':!dev/**' ':!**/layer_0/**' ':!**/github/**' ':!.github/**')
          echo "Layer 1 TEST File Changes:"
          echo "$LAYER_1_TEST_CHANGES"
          
          if [ -n "$LAYER_1_TEST_CHANGES" ]; then
            LAYER_1_TEST_CHANGES=$(echo "$LAYER_1_TEST_CHANGES" | tr '\n' ',' | jq -cRs 'split(",") | .[:-1]')
          else
            LAYER_1_TEST_CHANGES=[]
          fi

          echo "LAYER_1_TEST_CHANGES=${LAYER_1_TEST_CHANGES}" >> $GITHUB_ENV
      
      - name: Finding Layer 0 PROD Changes
        id: layer_0_prod_changes
        run: |
          LAYER_0_PROD_CHANGES=$(git diff --name-only ${{ needs.configure.outputs.base_sha }} HEAD -- ':!test/**' ':!dev/**' ':!**/layer_1/**' ':!**/github/**' ':!.github/**')
          echo "Layer 0 PROD File Changes:"
          echo "$LAYER_0_PROD_CHANGES"
          
          if [ -n "$LAYER_0_PROD_CHANGES" ]; then
            LAYER_0_PROD_CHANGES=$(echo "$LAYER_0_PROD_CHANGES" | tr '\n' ',' | jq -cRs 'split(",") | .[:-1]')
          else
            LAYER_0_PROD_CHANGES=[]
          fi

          echo "LAYER_0_PROD_CHANGES=${LAYER_0_PROD_CHANGES}" >> $GITHUB_ENV
      
      - name: Finding Layer 1 PROD Changes
        id: layer_1_prod_changes
        run: |
          LAYER_1_PROD_CHANGES=$(git diff --name-only ${{ needs.configure.outputs.base_sha }} HEAD -- ':!test/**' ':!dev/**' ':!**/layer_0/**' ':!**/github/**' ':!.github/**')
          echo "Layer 1 PROD File Changes:"
          echo "$LAYER_1_PROD_CHANGES"
          
          if [ -n "$LAYER_1_PROD_CHANGES" ]; then
            LAYER_1_PROD_CHANGES=$(echo "$LAYER_1_PROD_CHANGES" | tr '\n' ',' | jq -cRs 'split(",") | .[:-1]')
          else
            LAYER_1_PROD_CHANGES=[]
          fi

          echo "LAYER_1_PROD_CHANGES=${LAYER_1_PROD_CHANGES}" >> $GITHUB_ENV


  # deploy_github_repos:
  #   name: Deploy - GitHub Repos
  #   uses: CPC-SCP/iep-reusable-gha-workflows/.github/workflows/terraform-workflow.yml@main
  #   secrets: inherit
  #   needs:
  #     - configure
  #   if: needs.configure.outputs.MATRIX_GITHUB!= '[]'
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       directory: ${{ fromJson(needs.configure.outputs.matrix_github) }}
  #   with:
  #     environment: product-iac-repos-github
  #     tf_exec_aws_region: ${{ vars.TF_EXEC_AWS_REGION }}
  #     tf_exec_role_arn: ${{ vars.TF_EXEC_ROLE_ARN }}
  #     tf_version: 1.5
  #     tf_working_dir: ${{ matrix.directory }}

  layer_0_deploy_dev:
    name: Layer 0 - Deploy - Dev
    runs-on: ubuntu-latest
    # uses: CPC-SCP/iep-reusable-gha-workflows/.github/workflows/terraform-workflow.yml@main
    # secrets: inherit
    needs:
      - determine_changes
    if: ${{ needs.determine_changes.outputs.LAYER_0_DEV_CHANGES != '[]' }}
    # strategy:
    #   fail-fast: false
    #   matrix:
    #     directory: ${{ fromJson(needs.determine_changes.outputs.LAYER_0_DEV_CHANGES) }}
    steps:
      - name: Layer 0 - Deploy - Dev
        run: |
          echo "Layer 0 - Deploy - Dev"
    # with:
    #   environment: product-iac-repos-dev
    #   tf_exec_aws_region: ${{ vars.TF_EXEC_AWS_REGION }}
    #   tf_exec_role_arn: ${{ vars.TF_EXEC_ROLE_ARN }}
    #   tf_version: 1.5
    #   tf_working_dir: ${{ matrix.directory }}

  layer_1_deploy_dev:
    name: Layer 1 - Deploy - Dev
    runs-on: ubuntu-latest
    # uses: CPC-SCP/iep-reusable-gha-workflows/.github/workflows/terraform-workflow.yml@main
    # secrets: inherit
    needs:
      - determine_changes
    if: ${{ needs.determine_changes.outputs.LAYER_1_DEV_CHANGES != '[]' }}
    # strategy:
    #   fail-fast: false
    #   matrix:
    #     directory: ${{ fromJson(needs.determine_changes.outputs.LAYER_1_DEV_CHANGES) }}
    steps:
      - name: Layer 1 - Deploy - Dev
        run: |
          echo "Layer 1 - Deploy - Dev"
    # with:
    #   environment: product-iac-repos-dev
    #   tf_exec_aws_region: ${{ vars.TF_EXEC_AWS_REGION }}
    #   tf_exec_role_arn: ${{ vars.TF_EXEC_ROLE_ARN }}
    #   tf_version: 1.5
    #   tf_working_dir: ${{ matrix.directory }}

  layer_0_deploy_test:
    name: Layer 0 - Deploy - Test
    runs-on: ubuntu-latest
    # uses: CPC-SCP/iep-reusable-gha-workflows/.github/workflows/terraform-workflow.yml@main
    # secrets: inherit
    needs:
      - determine_changes
    if: ${{ needs.determine_changes.outputs.LAYER_0_TEST_CHANGES != '[]' }}
    # strategy:
    #   fail-fast: false
    #   matrix:
    #     directory: ${{ fromJson(needs.determine_changes.outputs.LAYER_0_TEST_CHANGES) }}
    steps:
      - name: Layer 0 - Deploy - Test
        run: |
          echo "Layer 0 - Deploy - Test"
    # with:
    #   environment: product-iac-repos-test
    #   tf_exec_aws_region: ${{ vars.TF_EXEC_AWS_REGION }}
    #   tf_exec_role_arn: ${{ vars.TF_EXEC_ROLE_ARN }}
    #   tf_version: 1.5
    #   tf_working_dir: ${{ matrix.directory }}

  layer_1_deploy_test:
    name: Layer 1 - Deploy - Test
    runs-on: ubuntu-latest
    # uses: CPC-SCP/iep-reusable-gha-workflows/.github/workflows/terraform-workflow.yml@main
    # secrets: inherit
    needs:
      - determine_changes
    if: ${{ needs.determine_changes.outputs.LAYER_1_TEST_CHANGES != '[]' }}
    # strategy:
    #   fail-fast: false
    #   matrix:
    #     directory: ${{ fromJson(needs.determine_changes.outputs.LAYER_1_TEST_CHANGES) }}
    steps:
      - name: Layer 1 - Deploy - Test
        run: |
          echo "Layer 1 - Deploy - Test"
    # with:
    #   environment: product-iac-repos-test
    #   tf_exec_aws_region: ${{ vars.TF_EXEC_AWS_REGION }}
    #   tf_exec_role_arn: ${{ vars.TF_EXEC_ROLE_ARN }}
    #   tf_version: 1.5
    #   tf_working_dir: ${{ matrix.directory }}

  layer_0_deploy_prod:
    name: Layer 0 - Deploy - Prod
    runs-on: ubuntu-latest
    # uses: CPC-SCP/iep-reusable-gha-workflows/.github/workflows/terraform-workflow.yml@main
    # secrets: inherit
    needs:
      - determine_changes
    if: ${{ needs.determine_changes.outputs.LAYER_0_PROD_CHANGES != '[]' }}
    # strategy:
    #   fail-fast: false
    #   matrix:
    #     directory: ${{ fromJson(needs.determine_changes.outputs.LAYER_0_PROD_CHANGES) }}
    steps:
      - name: Layer 0 - Deploy - Prod
        run: |
          echo "Layer 0 - Deploy - Prod"
    # with:
    #   environment: product-iac-repos-prod
    #   tf_exec_aws_region: ${{ vars.TF_EXEC_AWS_REGION }}
    #   tf_exec_role_arn: ${{ vars.TF_EXEC_ROLE_ARN }}
    #   tf_version: 1.5
    #   tf_working_dir: ${{ matrix.directory }}

  layer_1_deploy_prod:
    name: Layer 1 - Deploy - Prod
    runs-on: ubuntu-latest
    # uses: CPC-SCP/iep-reusable-gha-workflows/.github/workflows/terraform-workflow.yml@main
    # secrets: inherit
    needs:
      - determine_changes
    if: ${{ needs.determine_changes.outputs.LAYER_1_PROD_CHANGES != '[]' }}
    # strategy:
    #   fail-fast: false
    #   matrix:
    #     directory: ${{ fromJson(needs.determine_changes.outputs.LAYER_1_PROD_CHANGES) }}
    steps:
      - name: Layer 1 - Deploy - Prod
        run: |
          echo "Layer 1 - Deploy - Prod"
    # with:
    #   environment: product-iac-repos-prod
    #   tf_exec_aws_region: ${{ vars.TF_EXEC_AWS_REGION }}
    #   tf_exec_role_arn: ${{ vars.TF_EXEC_ROLE_ARN }}
    #   tf_version: 1.5
    #   tf_working_dir: ${{ matrix.directory }}